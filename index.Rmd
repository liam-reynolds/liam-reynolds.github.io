---
title: "Data Tool Prototype"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(tidycensus)
library(urbnthemes)
library(urbnmapr)
library(shiny)
library(leaflet)
library(sf)
library(tigris)
library(ipumsr)
library(highcharter)
library(readxl)
library(htmltools)

set_urbn_defaults(style = "print")

###Homeownership rate gap
hor_gap_data <- read_xlsx("hor_gap.xlsx") %>% 
  pivot_longer(black:all, names_to = "race", values_to = "hor") %>% 
  mutate(race = case_when(race == "all" ~ "total",
                          TRUE ~ race
    
  ))
  

###Geographic data

msa_acs <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
               year = 2019,
               survey = "acs5",
               variable = "B19013_001"
) %>% 
  select(msa_code = GEOID, msa_name = NAME) %>% 
  filter(str_detect(msa_name, "GA"))

crosswalk <- read.csv("crosswalk.csv") %>% 
  select(cbsacode, cbsatitle, fipsstatecode, fipscountycode) %>% 
  mutate(state_fips = str_pad(fipsstatecode, 2, "left", "0"),
         county_fips = str_pad(fipscountycode, 3, "left", "0"),
         county_fips = str_c(state_fips, county_fips),
         cbsacode = as.character(cbsacode))

msa_list <- msa_acs %>% 
  left_join(crosswalk, by = c("msa_code" = "cbsacode"))
  
  
county_list <- get_acs(geography = "county",
                       state = "GA",
                       year = 2019,
                       survey = "acs5",
                       variable = "B19013_001") %>% 
  select(county_fips = GEOID, county_name = NAME)

tract_list <- get_acs(geography = "tract",
                       state = "GA",
                       year = 2019,
                       survey = "acs5",
                       variable = "B19013_001") %>% 
  select(fips = GEOID, tract_name = NAME) %>% 
  mutate(county_fips = str_sub(fips, 1, 5))

counties_tracts <- tract_list %>% 
  left_join(county_list, by = "county_fips")


msa_county_tract <- msa_list %>% 
  left_join(counties_tracts, by = "county_fips")

map_tract <- get_acs(geography = "tract",
                    state = "GA",
                    year = 2019,
                    survey = "acs5",
                    variable = "B19013_001",
                    geometry = TRUE
) %>% 
  select(-estimate, -moe, -variable) %>% 
  rename(fips = GEOID) %>% 
  mutate(county_fips = str_sub(fips, 1, 5)) %>%
  left_join(counties_tracts, by = "fips")


msa_geo <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
               year = 2019,
               survey = "acs5",
               variable = "B19013_001",
               geometry = TRUE
               ) %>% 
  select(msa_code = GEOID, msa_name = NAME, geometry)

###Chart Data

##Demographics

dem_tract <- get_acs(geography = "tract",
                     state = "GA",
                     year = 2019,
                     survey = "acs5",
                     variables = c(white = "B25003H_001",
                                   black = "B25003B_001",
                                   latino = "B25003I_001",
                                   aian = "B25003C_001",
                                   asian = "B25003D_001",
                                   islander = "B25003E_001",
                                   other = "B25003F_001",
                                   multiple = "B25003G_001"),
                     summary_var = c(tot = "B25003_001")
) %>% 
  mutate(race = case_when(variable %in% c("white", "black", "latino") ~ variable,
                          TRUE ~ "other")) %>% 
  group_by(GEOID, race) %>% 
  summarise(hh = sum(estimate),
            hh_tot = summary_est,
            tract_name = NAME) %>% 
  unique()


dem_county <- get_acs(geography = "county",
                      state = "GA",
                      year = 2019,
                      survey = "acs5",
                      variables = c(white = "B25003H_001",
                                    black = "B25003B_001",
                                    latino = "B25003I_001",
                                    aian = "B25003C_001",
                                    asian = "B25003D_001",
                                    islander = "B25003E_001",
                                    other = "B25003F_001",
                                    multiple = "B25003G_001"),
                      summary_var = c(tot = "B25003_001")
) %>% 
  mutate(race = case_when(variable %in% c("white", "black", "latino") ~ variable,
                          TRUE ~ "other")) %>% 
  group_by(GEOID, race) %>% 
  summarise(hh = sum(estimate),
            hh_tot = summary_est,
            tract_name = NAME) %>% 
  unique()

dem_msa <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
                      year = 2019,
                      survey = "acs5",
                      variables = c(white = "B25003H_001",
                                    black = "B25003B_001",
                                    latino = "B25003I_001",
                                    aian = "B25003C_001",
                                    asian = "B25003D_001",
                                    islander = "B25003E_001",
                                    other = "B25003F_001",
                                    multiple = "B25003G_001"),
                      summary_var = c(tot = "B25003_001")
) %>% 
  mutate(race = case_when(variable %in% c("white", "black", "latino") ~ variable,
                          TRUE ~ "other")) %>% 
  group_by(GEOID, race) %>% 
  summarise(hh = sum(estimate),
            hh_tot = summary_est,
            tract_name = NAME) %>% 
  unique()

  
dem_shares_tract <- dem_tract %>% 
  select(tract_fips = GEOID, tract_name, race, hh, hh_tot) %>% 
  mutate(county_fips = str_sub(tract_fips, 1, 5),
         county_fips_race = case_when(race == "black" ~ paste0(county_fips, "_b"),
         race == "white" ~ paste0(county_fips, "_w"),
         race == "latino" ~ paste0(county_fips, "_l"),
         TRUE ~ paste0(county_fips, "_o")
  )) %>% 
  group_by(tract_fips, race) %>% 
  summarise(tract = (hh / hh_tot) * 100,
            tract_name = tract_name,
            county_fips_race = county_fips_race)


dem_shares_county <- dem_county %>% 
  select(county_fips = GEOID, race, hh, hh_tot) %>% 
  mutate(county_fips_race = case_when(race == "black" ~ paste0(county_fips, "_b"),
                                      race == "white" ~ paste0(county_fips, "_w"),
                                      race == "latino" ~ paste0(county_fips, "_l"),
                                      TRUE ~ paste0(county_fips, "_o"))) %>% 
  group_by(county_fips, race) %>% 
  summarise(county = (hh / hh_tot) * 100,
            county_fips_race = county_fips_race)


dem_shares_msa <- dem_msa %>% 
  select(cbsa_fips = GEOID, race, hh, hh_tot) %>%
  left_join(crosswalk, by = c("cbsa_fips" = "cbsacode")) %>% 
  select(-cbsatitle, -fipsstatecode, -fipscountycode, -state_fips)  %>% 
  mutate(county_fips_race = case_when(race == "black" ~ paste0(county_fips, "_b"),
                                      race == "white" ~ paste0(county_fips, "_w"),
                                      race == "latino" ~ paste0(county_fips, "_l"),
                                      TRUE ~ paste0(county_fips, "_o"))) %>% 
  group_by(cbsa_fips, race) %>% 
  summarise(msa = (hh / hh_tot) * 100,
            county_fips_race = county_fips_race)

dem_chart <- dem_shares_tract %>% 
  left_join(dem_shares_county, by = "county_fips_race") %>% 
  left_join(dem_shares_msa, by = "county_fips_race") %>% 
  select(tract_fips, tract_name, race = race.x, tract, county, msa) %>% 
  pivot_longer(cols = tract:msa, names_to = "geo_type", values_to = "household_share") 

residence_race <- c("Asian", "Black", "Latino", "Other", "White")

household <- c(.06, .16, .12, .03, .63)
residence_wealth <- c(.08, .06, .09, .02, .75)
dist_household_home_wealth <- data.frame(residence_race, household, residence_wealth) %>% 
  pivot_longer(household:residence_wealth, names_to = "household_wealth", values_to = "share")

household <- c(.053, .443, .039, .019, .446)
residence_wealth <- c(.051, .174, .038, .021, .715)
dist_household_home_wealth_atl <- data.frame(residence_race, household, residence_wealth) %>% 
  pivot_longer(household:residence_wealth, names_to = "household_wealth", values_to = "share")

##HOR
#HOR TRACT
black_acs <- get_acs(geography = "tract",
                     state = "GA",
                     year = 2019,
                     survey = "acs5",
                     variables = c(black_ownocc = "B25003B_002"),
                     summary_var = "B25003B_001"
)

white_acs <- get_acs(geography = "tract",
                     state = "GA",
                     year = 2019,
                     survey = "acs5",
                     variables = c(white_ownocc = "B25003H_002"),
                     summary_var = "B25003A_001"
  
)

tot_acs <- get_acs(geography = "tract",
                   state = "GA",
                   year = 2019,
                   survey = "acs5",
                   variables = c(ownocc = "B25003_002"),
                   summary_var = "B25003_001"
)

black_hor <- black_acs %>% 
  mutate(black_hor = (estimate / summary_est) * 100) %>% 
  select(GEOID, NAME, black_hor)
  
white_hor <- white_acs %>% 
  mutate(white_hor = (estimate / summary_est) * 100) %>% 
  select(GEOID, white_hor)

tot_hor <- tot_acs %>% 
  mutate(tot_hor = (estimate / summary_est) * 100) %>% 
  select(GEOID, tot_hor)

#HOR COUNTY
black_acs_county <- get_acs(geography = "county",
                     state = "GA",
                     year = 2019,
                     survey = "acs5",
                     variables = c(black_ownocc = "B25003B_002"),
                     summary_var = "B25003B_001"
)

white_acs_county <- get_acs(geography = "county",
                     state = "GA",
                     year = 2019,
                     survey = "acs5",
                     variables = c(white_ownocc = "B25003H_002"),
                     summary_var = "B25003A_001"
  
)

tot_acs_county <- get_acs(geography = "county",
                   state = "GA",
                   year = 2019,
                   survey = "acs5",
                   variables = c(ownocc = "B25003_002"),
                   summary_var = "B25003_001"
)

black_hor_county <- black_acs_county %>% 
  mutate(black_hor_county = (estimate / summary_est) * 100) %>% 
  select(GEOID, NAME, black_hor_county)
  
white_hor_county <- white_acs_county %>% 
  mutate(white_hor_county = (estimate / summary_est) * 100) %>% 
  select(GEOID, white_hor_county)

tot_hor_county <- tot_acs_county %>% 
  mutate(tot_hor_county = (estimate / summary_est) * 100) %>% 
  select(GEOID, tot_hor_county)

#HOR MSA 
black_acs_msa <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
                         year = 2019,
                         survey = "acs5",
                         variables = c(black_ownocc = "B25003B_002"),
                         summary_var = "B25003B_001"
)


white_acs_msa <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
                         year = 2019,
                         survey = "acs5",
                         variables = c(white_ownocc = "B25003H_002"),
                         summary_var = "B25003A_001"
)

tot_acs_msa <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
                   year = 2019,
                   survey = "acs5",
                   variables = c(ownocc = "B25003_002"),
                   summary_var = "B25003_001"
)

black_hor_msa <- black_acs_msa %>% 
  mutate(black_hor_msa = (estimate / summary_est) * 100) %>% 
  select(GEOID, NAME, black_hor_msa) 
  
white_hor_msa <- white_acs_msa %>% 
  mutate(white_hor_msa = (estimate / summary_est) * 100) %>% 
  select(GEOID, NAME, white_hor_msa) 
 
tot_hor_msa <- tot_acs_msa %>% 
  mutate(tot_hor_msa = (estimate / summary_est) * 100) %>% 
  select(GEOID, NAME, tot_hor_msa)
  
hor_tract <- black_hor %>% 
  left_join(white_hor, by = "GEOID") %>% 
  left_join(tot_hor, by = "GEOID") %>% 
  mutate(county_fips = str_sub(GEOID, 1, 5)) %>% 
  pivot_longer(cols = c("black_hor", "white_hor", "tot_hor")) %>% 
  mutate(county_fips_race = case_when(name == "black_hor" ~ paste0(county_fips, "_b"),
                                      name == "white_hor" ~ paste0(county_fips, "_w"),
                                      TRUE ~ paste0(county_fips, "_t"))
         )


hor_county <- black_hor_county %>% 
  left_join(white_hor_county) %>% 
  left_join(tot_hor_county) %>% 
  pivot_longer(cols = c("black_hor_county", "white_hor_county", "tot_hor_county")) %>% 
  mutate(county_fips_race = case_when(name == "black_hor_county" ~ paste0(GEOID, "_b"),
                                      name == "white_hor_county" ~ paste0(GEOID, "_w"),
                                      TRUE ~ paste0(GEOID, "_t"))
         )

hor_msa <- black_hor_msa %>% 
  left_join(white_hor_msa) %>% 
  left_join(tot_hor_msa) %>% 
  left_join(crosswalk, by = c("GEOID" = "cbsacode")) %>% 
  pivot_longer(cols = c("black_hor_msa", "white_hor_msa", "tot_hor_msa")) %>% 
  mutate(county_fips_race = case_when(name =="black_hor_msa" ~ paste0(county_fips, "_b"),
                                      name == "white_hor_msa" ~ paste0(county_fips, "_w"),
                                      TRUE ~ paste0(county_fips, "_t"))) %>% 
  select(-GEOID, -fipsstatecode, -fipscountycode, -state_fips, -NAME) %>% 
  mutate(value = value / 100)
hor_msa$name <- factor(hor_msa$name, levels = c("black_hor_msa", "white_hor_msa", "tot_hor_msa"))

hor_clean <- hor_tract %>% 
  left_join(hor_county, by = "county_fips_race") %>% 
  left_join(hor_msa, by = "county_fips_race") %>% 
  select(fips = GEOID.x, tract_name =  NAME.x, tract = value.x, county = value.y, msa = value, county_name = NAME.y, race = name.x) %>% 
  pivot_longer(cols = tract:msa, names_to = "geo_type", values_to = "rate") %>% 
  mutate(rate = (rate / 100))
hor_clean$race <- factor(hor_clean$race, levels = c("black_hor", "white_hor", "tot_hor"))

map_data <- map_tract %>% 
  st_join(msa_geo, join = st_within) %>% 
  filter(msa_name == "Atlanta-Sandy Springs-Alpharetta, GA Metro Area") %>% 
  left_join(hor_clean, by = "fips") %>% 
  filter(geo_type == "tract") %>%
  select(fips, NAME, county_fips = county_fips.x, tract_name = tract_name.x, county_name = county_name.x, msa_code, msa_name, geometry, race, -geo_type,
         rate) %>% 
  mutate(race = case_when(race == "black_hor" ~ "black", 
                          race == "white_hor" ~ "white",
                          race == "tot_hor" ~ "total"),
         rate = rate * 100,
         rate = round(rate, 1),
         rate = paste0(rate, "%")
  ) %>% 
  pivot_wider(names_from = "race", values_from = "rate")

pal <- colorFactor(
  palette = "magma",
  domain = map_data$county_name
)

##Denial
denial_msa_atlanta <- read.csv("denial_msa_atlanta.csv") %>% 
  rename(race = race_msa,
         denial = msa)
denial_msa_atlanta$race <- factor(denial_msa_atlanta$race, levels = c("black", "white", "tot"))

denial_race <- c("Black", "White", "Total")
denial_rate <- c(0.245, 0.105, 0.134)

denial_national <- data.frame(denial_race, denial_rate)
denial_national$denial_race <- factor(denial_national$denial_race, levels = c("Black", "White", "Total"))

##HOR Race, Income, Education
ddi <- read_ipums_ddi("usa_00024.xml")
data <- read_ipums_micro(ddi) %>% 
 rename_all(tolower)

cbsa_names <- dem_msa %>% 
  ungroup() %>% 
  select(GEOID, tract_name)

data_clean <- data %>% 
  filter(pernum == 1,
         hhincome != 9999999) %>% 
  mutate(race = case_when(race == 1 & hispan == 0 ~ "white",
                          race == 2 & hispan == 0 ~ "black"),
         grad = if_else(educd %in% c(081, 101, 114, 115, 116), "degree", "no degree"),
         inc = case_when(hhincome < 50000 ~ "under 50K",
                         hhincome >= 50000 & hhincome < 100000 ~ "50 - 100K",
                         hhincome >= 100000 & hhincome < 150000 ~ "100 - 150K",
                         hhincome >= 150000 ~ "150K +"),
         met2013 = as.character(met2013)
  ) %>% 
  left_join(cbsa_names, by = c("met2013" = "GEOID")) %>% 
  rename(msa_name = tract_name)

hor_inc_tot_national <- data_clean %>% 
  group_by(inc) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt)) %>% 
  mutate(race = "total")

hor_inc_race_national <- data_clean %>% 
  group_by(race, inc) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt)) %>% 
  filter(!is.na(race))

hor_inc_national <- hor_inc_tot_national %>% 
  rbind(hor_inc_race_national)
hor_inc_national$race <- factor(hor_inc_national$race, levels = c("black", "white", "total"))
hor_inc_national$inc <- factor(hor_inc_national$inc, levels = c("under 50K", "50 - 100K", "100 - 150K", "150K +"))

hor_inc_tot <- data_clean %>% 
  group_by(msa_name, inc) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt)) %>% 
  mutate(race = "total")

hor_inc_race <- data_clean %>% 
  group_by(msa_name, race, inc) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt))

hor_inc_race_chart <- hor_inc_race %>% 
  rbind(hor_inc_tot) %>% 
  filter(!is.na(race)) %>% 
  arrange(msa_name, race)
hor_inc_race_chart$race <- factor(hor_inc_race_chart$race, levels = c("black", "white", "total"))
hor_inc_race_chart$inc <- factor(hor_inc_race_chart$inc, levels = c("under 50K", "50 - 100K", "100 - 150K", "150K +"))

hor_educ_tot_national <- data_clean %>% 
  group_by(grad) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt)) %>% 
  mutate(race = "total")

hor_educ_race_national <- data_clean %>% 
  group_by(race, grad) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt))

hor_educ_national <- hor_educ_race_national %>% 
  rbind(hor_educ_tot_national) %>% 
  filter(!is.na(race))

hor_educ_tot <- data_clean %>% 
  group_by(msa_name, grad) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt)) %>% 
  mutate(race = "total")
hor_educ_national$race <- factor(hor_educ_national$race, levels = c("black", "white", "total"))
hor_educ_national$grad <- factor(hor_educ_national$grad, levels = c("no degree", "degree"))



hor_educ_race <- data_clean %>% 
  group_by(msa_name, race, grad) %>% 
  summarise(rate = sum(hhwt[ownershp == 1]) / sum(hhwt))

hor_educ_race_chart <- hor_educ_race %>% 
  rbind(hor_educ_tot) %>% 
  filter(!is.na(race)) %>% 
  arrange(msa_name, race)
hor_educ_race_chart$race <- factor(hor_educ_race_chart$race, levels = c("black", "white", "total"))
hor_educ_race_chart$grad <- factor(hor_educ_race_chart$grad, levels = c("no degree", "degree"))

##national wealth gap
race <- c("Black", "White")
wealth <- c(24100, 188200)
wealth_gap <- data.frame(race, wealth)

parent_worth <- c("<10K", "$10K - 50K", "50K - 150K", "150K - 300K", ">300K")
rate <- c(.1414, .1908, .2965, .3176, .3639)
parent_wealth <-data.frame(parent_worth, rate)
parent_wealth$parent_worth <- factor(parent_wealth$parent_worth, levels = c("<10K", "$10K - 50K", "50K - 150K", "150K - 300K", ">300K"))

financial_health <- read_xlsx ("3_city_financial_health_metrics.xlsx") %>% 
  rename("city_name" = "city name",
         "Total" = "Median net worth (estimated); Overall",
         "White" = "Median net worth (estimated); White",
         "Black" = "Median net worth (estimated); Black") %>% 
  mutate(White = as.numeric(White),
         Black = as.numeric(Black)) %>% 
  select(city_name, Black, White, Total) %>% 
  pivot_longer(Black:Total, names_to = "race", values_to = "net_worth" )
financial_health$race <- factor(financial_health$race, levels = c("Black", "White", "Total"))

##cost burden
ddi <- read_ipums_ddi("usa_00028.xml")
data <- read_ipums_micro(ddi) %>% 
  rename_all(tolower) %>% 
  filter(pernum == 1)

race <- c("Black", "Total", "White")
burden_race_national <- c(.51, .46, .42)
national_burden <- data.frame(race, burden_race_national)


burden_msa_tot <- data %>% 
  select(msa_name = met2013, state_fips = statefip, county_fips = countyfip, hhincome, ownershp, race, hispan, rent, hhwt) %>% 
  filter(county_fips != 000,
         rent != 0) %>% 
  mutate(county_fips = str_pad(county_fips, 3, "left", "0"),
         state_fips = str_pad(state_fips, 2, "left", "0"),
         county_fips = str_c(state_fips, county_fips)) %>%
  filter(hhincome != 9999999,
         ownershp == 2) %>%
  mutate(rent = (rent *12),
         ratio = (rent / hhincome),
         ethrace = "tot") %>% 
  group_by(msa_name) %>% 
  summarise(msa = (sum(hhwt[ratio >= .30] / sum(hhwt), na.rm = TRUE)),
            county_fips = county_fips,
            ethrace = ethrace) %>% 
  unique()

burden_msa <- data %>% 
  select(msa_name = met2013, state_fips = statefip, county_fips = countyfip, hhincome, ownershp, race, hispan, rent, hhwt) %>% 
  filter(county_fips != 000,
         rent != 0) %>% 
  mutate(ethrace = case_when(race == 1 & hispan == 0 ~ "white", 
                             race == 2 & hispan == 0 ~ "black"),
         county_fips = str_pad(county_fips, 3, "left", "0"),
         state_fips = str_pad(state_fips, 2, "left", "0"),
         county_fips = str_c(state_fips, county_fips)) %>%
  filter(hhincome != 9999999,
         ethrace %in% c("white", "black"),
         ownershp == 2) %>%
  mutate(rent = (rent * 12),
         ratio = (rent / hhincome)) %>% 
  group_by(msa_name, ethrace) %>% 
  summarise(msa = (sum(hhwt[ratio >= .30] / sum(hhwt), na.rm = TRUE)),
            county_fips = county_fips) %>% 
  unique() %>% 
  rbind(burden_msa_tot) %>%
  arrange(msa_name, county_fips, ethrace) %>% 
  unique() %>% 
  mutate(county_fips_race = case_when(ethrace == "black" ~ paste0(county_fips, "_b"),
                                      ethrace == "white" ~ paste0(county_fips, "_w"),
                                      TRUE ~ paste0(county_fips, "_t"))
  )

  
burden_county_tot <- data %>% 
  select(msa_name = met2013, state_fips = statefip, county_fips = countyfip, hhincome, ownershp, race, hispan, rent, hhwt) %>% 
  filter(county_fips != 000,
         rent != 0) %>% 
  mutate(county_fips = str_pad(county_fips, 3, "left", "0"),
         state_fips = str_pad(state_fips, 2, "left", "0"),
         county_fips = str_c(state_fips, county_fips)) %>%
  filter(hhincome != 9999999,
         ownershp == 2) %>%
  mutate(rent = (rent * 12),
         ratio = (rent / hhincome)) %>% 
  group_by(county_fips) %>% 
  summarise(county = (sum(hhwt[ratio >= .30] / sum(hhwt), na.rm = TRUE)),
            county_fips = county_fips) %>% 
  mutate(ethrace = "tot") %>%  
  unique()


burden_county <- data %>% 
  select(msa = met2013, state_fips = statefip, county_fips = countyfip, hhincome, ownershp, race, hispan, rent, hhwt) %>% 
  filter(county_fips != 000,
         rent != 0) %>% 
  mutate(ethrace = case_when(race == 1 & hispan == 0 ~ "white", 
                             race == 2 & hispan == 0 ~ "black"),
         county_fips = str_pad(county_fips, 3, "left", "0"),
         state_fips = str_pad(state_fips, 2, "left", "0"),
         county_fips = str_c(state_fips, county_fips)) %>%
  filter(hhincome != 9999999,
         ethrace %in% c("white", "black"),
         ownershp == 2) %>%
  mutate(rent = (rent * 12),
         ratio = (rent / hhincome)) %>% 
  group_by(county_fips, ethrace) %>% 
  summarise(county = (sum(hhwt[ratio >= .30] / sum(hhwt), na.rm = TRUE)),
            county_fips = county_fips) %>% 
  unique() %>% 
  rbind(burden_county_tot) %>%
  arrange(county_fips, ethrace) %>% 
  unique() %>% 
  mutate(county_fips_race = case_when(ethrace == "black" ~ paste0(county_fips, "_b"),
                                    ethrace == "white" ~ paste0(county_fips, "_w"),
                                    TRUE ~ paste0(county_fips, "_t"))
)


burden <- burden_county %>% 
  left_join(burden_msa, by = "county_fips_race") %>% 
  select(msa_name, county_fips = county_fips.x, race = ethrace.x, msa, county) %>% 
  arrange(msa_name, county_fips, race) %>% 
  pivot_longer(cols = msa:county, names_to = "geo_type", values_to = "burden_share") %>% 
  mutate(msa_name = as.character(msa_name)) %>% 
  left_join(msa_list, by = c("msa_name" = "msa_code")) %>% 
  select(msa_code = msa_name, msa_name = msa_name.y, county_fips = county_fips.x, race, geo_type, burden_share) %>% 
  unique()
burden$race <- factor(burden$race, levels = c("black", "white", "tot"))

##wealth by tenure
tenure <- c("Renter", "Owner")
wealth <- c(6300, 255000)
wealth_tenure <- data.frame(tenure, wealth)


##LTV
ltv <- read.csv("ltv_share_msa_county.csv") %>% 
  select(derived_msa_md, county_fips, race = raceeth, below_5_county, above_20_county, below_5_msa, above_20_msa) %>% 
  pivot_longer(cols = below_5_county:above_20_msa, names_to = "down", values_to = "rate") %>% 
  mutate(payment = case_when(down %in% c("below_5_county", "below_5_msa") ~ "below 5",
                             down %in% c("above_20_county", "above_20_msa") ~ "above 20"),
         geo_type = case_when(down %in% c("below_5_county", "above_20_county") ~ "county",
                              down %in% c("below_5_msa", "above_20_msa") ~ "msa")) %>% 
  select(-down) %>% 
  mutate(msa_code = as.character(derived_msa_md)) %>%
  left_join(msa_acs, by = "msa_code") %>% 
  filter(geo_type != "county")

ltv_national <- read.csv("ltv_share_national.csv") %>% 
  pivot_longer(cols = below_5:above_20, names_to = "down", values_to = "rate")
  

##Source of Down Payment
nsmo_clean <- read.csv("nsmo_clean.csv")

source_race <- nsmo_clean %>%
  filter(race_eth %in% c("White", "Black"),
         mortgage_reason == 1,
         sale_proceeds != -2,
         savings_retire_etc != -2,
         govt_np_asst != -2,
         second_lien_heloc != -2 & second_lien_heloc != -3,
         gift != -2,
         seller_cont != -2) %>% 
  group_by(race_eth) %>% 
  summarise(sale_proceeds = weighted.mean(sale_proceeds, w = weight, na.rm = TRUE),
            savings_retire_etc = weighted.mean(savings_retire_etc, w = weight, na.rm = TRUE),
            govt_np_asst = weighted.mean(govt_np_asst, w = weight, na.rm = TRUE),
            second_lien_heloc = weighted.mean(second_lien_heloc, w = weight, na.rm = TRUE),
            gift = weighted.mean(gift, w = weight, na.rm = TRUE),
            seller_cont = weighted.mean(seller_cont, w = weight, na.rm = TRUE)
            )

source_tot <- nsmo_clean %>% 
  filter(mortgage_reason == 1,
         sale_proceeds != -2,
         savings_retire_etc != -2,
         govt_np_asst != -2,
         second_lien_heloc != -2 & second_lien_heloc != -3,
         gift != -2,
         seller_cont != -2) %>% 
  summarise(sale_proceeds = weighted.mean(sale_proceeds, w = weight, na.rm = TRUE),
            savings_retire_etc = weighted.mean(savings_retire_etc, w = weight, na.rm = TRUE),
            govt_np_asst = weighted.mean(govt_np_asst, w = weight, na.rm = TRUE),
            second_lien_heloc = weighted.mean(second_lien_heloc, w = weight, na.rm = TRUE),
            gift = weighted.mean(gift, w = weight, na.rm = TRUE),
            seller_cont = weighted.mean(seller_cont, w = weight, na.rm = TRUE)
  ) %>% 
  mutate(race_eth = "Total")

source <- source_race %>% 
  rbind(source_tot)
source$race_eth <- factor(source$race_eth, levels = c("Black", "White", "Total"))


```

State of the Gap: Homeownership Disparities by Race and Ethnicity
============================================================================

Large gaps in homeownership rates and wealth persist between racial/ethnic groups as households of color face significant disadvantages relative to white households in both attaining and sustaining homeownership. The Black-white homeownership rate gap is almost as wide now as it was in 1960, when the Fair Housing Act had not yet been passed and housing discrimination was still legal (McCargo & Choi 2020).  The persistence of these gaps, long after overtly discriminatory practices have been barred, is evidence of the systemic barriers that still prevent people of color from receiving credit, or receiving it on terms as favorable as white borrowers. 

In the mid-20th century, the Federal Home Owner’s Loan Corporation (HOLC), the precursor to the Federal Housing Agency, explicitly and systematically denied mortgage lending to communities that were predominantly non-white through a process known as redlining (Rothstein, 2017). Racially restrictive covenants in the early 20th  century prohibited African Americans, Latinos, Asians and other non-white households from purchasing or owning homes in certain, often affluent and white, communities (Turner and Greene). People of color had less access to the 30-year mortgages, revolving credit, and Federal Deposit Insurance Corporation–backed bank accounts that underpinned the growing middle class. In their absence, costlier, riskier, and less regulated alternatives filled the void, using business models that often trapped people in cycles of debt and limited their ability to build a traditional credit history (Perry, Choi, and Reynolds blog). For example, Black homebuyers disproportionately utilized land sale contracts to purchase housing, which lack the protections of mortgage financing in default scenarios. Between 1950-1970, in Chicago alone it is estimated land sale contracts stripped Black households of between 3.2 and 4.0 billion in wealth (George et al. 2019, Brown 2016). 

More recently, driven by targeted lending of predatory products to borrowers of color, the great recession had a greater negative economic impact on homeowners of color. During the foreclosure crisis, Black and Hispanic households were 76 and 71 percent more likely to be foreclosed on than white owners, respectively (Bocian, Li and Ernst 2010, Neal and McCargo 2020, Choi et al. 2019). Negative shocks like recessions and natural disasters still disproportionally impact homeowners of color, widening gaps and setting vulnerable households further back. Prohibitively tight credit in the aftermath of the 2008 recession reduced lending to Black and Hispanic borrowers by 76 and 78 percent from 2005 to 2012 (Goodman, Zhu and George 2014). 

The staple legislation aimed at remedying historic lending discrimination, the Community Reinvestment Act (CRA), has fallen short of creating equal access to housing credit. Majority-minority communities receive less lending as a share of households than white neighborhoods, and research demonstrates that low-to-moderate designation that guides CRA activity is not a strong proxy for race (Goodman et al. 2022).


Homeownership Rates {.tabset}
-----------------------------------------------------------------------

### Homeownership Rate by Race, National 1960 - 2021
Large gaps in homeownership rates and wealth persis between racial/ethnic groups as households of color face significant disadvantages relative to white households in both attaining and sustaining homeownership. The Black-white homeownership gap is almost as wide now as it was in 1960, before the Fair Housing Act was passed and when housing discrimination was still legal. The persistence of this gap suggests that systemic racism is maintaing the same outcomes as the overtly racist practices of the past. 

```{r echo = FALSE}

  hor_gap_data %>% 
    ggplot(aes(colour = race, x = year, y = hor)) +
    geom_line(position = "identity", stat = "identity") +
    scale_colour_discrete(name = "", labels = c("Black", "Total", "White")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Homeownership Rate by Race, National 1960 - 2021") +
    xlab("Year") +
    ylab("Homeownership Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022. 2020 and 2021 numbers are from Census Bureau datatables, and racial category definitions\nare not perfectlyaligned between the two.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))




```

### Homeownership Rate by Race, MSA
The Black-white homeownership gap persists in most metro areas. In the Atlanta - Sandy Springs - Alpharetta MSA, the homeownership rate among white households is 70%, compared to 48% among Black households. 

```{r echo = FALSE}

  hor_msa %>%
    filter(cbsatitle == "Atlanta-Sandy Springs-Roswell, GA") %>% 
    unique() %>% 
    ggplot(aes(x = name, y = value, label = scales::percent(value))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_x_discrete(labels = c("Black", "White", "Total")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Homeownership Rate by Race, Atlanta MSA") +
    xlab("Race") +
    ylab("Homeownership Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```

### Distribution of Households and Primary-Residence Wealth by Race, National
Despite accounting for 16% of all households, Black households own only 6% of primary residence wealth. Conversely, white households account for 63% of households but 75% of primary residence wealth.

```{r echo = FALSE}

dist_household_home_wealth %>% 
  ggplot(aes(fill = residence_race, x = household_wealth, y = share)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_discrete(name = "") +
  scale_x_discrete(labels = c("Households", "Primary\nResidence Wealth")) +
  scale_y_continuous(labels = scales::percent_format()) +
  ggtitle("Distribution of Households and Primary-Residence Wealth by Race, National") +
  xlab("") +
  ylab("Share") +
  labs(caption = "Source: chart produced by Urban Institute, 2022.") +
  theme(axis.text.x = element_text(size= 20),
        axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        plot.caption = element_text(hjust = 0))


```

### Distribution of Households and Primary-Residence Wealth by Race, MSA
In Atlanta, Black households account for 44% of all households, but they own only 17% of primary residence wealth. White households make up 45% of households and own 72% of primary residence wealth.

```{r echo = FALSE}

dist_household_home_wealth_atl %>% 
  ggplot(aes(fill = residence_race, x = household_wealth, y = share)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_discrete(name = "") +
  scale_x_discrete(labels = c("Households", "Primary\nResidence Wealth")) +
  scale_y_continuous(labels = scales::percent_format()) +
  ggtitle("Distribution of Households and Primary-Residence Wealth by Race, Atlanta") +
  xlab("") +
  ylab("Share") +
  labs(caption = "Source: chart produced by Urban Institute, 2022.") +           theme(axis.text.x = element_text(size= 20),
      axis.text.y = element_text(size = 20),
      legend.title = element_text(size = 20),
      legend.text = element_text(size = 20),
      plot.caption = element_text(hjust = 0))


```


Denial Rates {.tabset}
-----------------------------------------------------------------------
### Denial Rate by Race: Purchase Mortgages, National
The national denial rate for purchase mortgage applications is 25% for Black applicants, compared to 11% for white applicants.

```{r echo = FALSE}

  denial_national %>% 
    ggplot(aes(x = denial_race, y = denial_rate, label = scales::percent(denial_rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_fill_discrete(labels = c("Black", "White", "Total")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Mortgage Application Denial Rate by Race, National") +
    xlab("Race") +
    ylab("Denial Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))
    
```



### Denial Rate by Race: Purchase Mortgages, MSA
In the Atlanta - Sandy Springs - Alpharetta MSA, the denial rate for Black applicants is 16%, comapred to 7% for white applicants. 

```{r echo = FALSE}

  denial_msa_atlanta %>% 
    ggplot(aes(x = race, y = denial, label = scales::percent(denial))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_x_discrete(labels = c("Black", "White", "Total")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Mortgage Application Denial Rate by Race, Atlanta MSA") +
    xlab("Race") +
    ylab("Denial Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))
    
```



Income {.tabset}
-----------------------------------------------------------------------
Barriers persist even when comparing among groups with similar levels of income.

### Homeownership by Race and Income, National

```{r echo = FALSE}

  hor_inc_national %>% 
    mutate(rate = round(rate, 1)) %>% 
    ggplot(aes(fill = race, x = inc, y = rate, label = scales::percent(rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_x_discrete(labels = c("Under\n$50k", "$50 -\n$100k", "$100 -\n $150k", "$150k +")) +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +  
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Homeownership Rate by Race and Household Income, National") +
    xlab("Household Income") +
    ylab("Homeownership Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```


### Homeownership by Race and Income, MSA

```{r echo = FALSE}

  hor_inc_race_chart %>% 
    filter(msa_name == "Atlanta-Sandy Springs-Alpharetta, GA Metro Area") %>% 
    mutate(rate = round(rate, 2)) %>% 
    ggplot(aes(fill = race, x = inc, y = rate, label = scales::percent(rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_x_discrete(labels = c("Under\n$50k", "$50 -\n$100k", "$100 -\n $150k", "$150k +")) +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +  
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Homeownership Rate by Race and Household Income, Atlanta MSA") +
    xlab("Household Income") +
    ylab("Homeownership Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```



Education {.tabset}
-----------------------------------------------------------------------
Similarly, the Black-white homeownership gap remains even when comparing among groups with similar levels of educational attainment.

### Homeownership by Race and Education, National

```{r echo = FALSE}

  hor_educ_national %>% 
    ggplot(aes(fill = race, x = grad, y = rate, label = scales::percent(rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +
    scale_x_discrete(labels = c("No Degree", "Degree")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Homeownership Rate by Race and Householder Educational Attainment, National") +
    xlab("Householder Educational Attainment") +
    ylab("Homeownership Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```



### Homeownership by Race and Education, MSA

```{r echo = FALSE}

  hor_educ_race_chart %>% 
    mutate(rate = round(rate, 3)) %>% 
    filter(msa_name == "Atlanta-Sandy Springs-Alpharetta, GA Metro Area") %>% 
    ggplot(aes(fill = race, x = grad, y = rate, label = scales::percent(rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +
    scale_x_discrete(labels = c("No Degree", "Degree")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Homeownership Rate by Race and Householder Educational Attainment, Atlanta MSA") +
    xlab("Householder Educational Attainment") +
    ylab("Homeownership Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```


Wealth Disparities: Black Renters are Less Likely to Have Access to Wealth for Down Payments
============================================================================

Black and Latino families consistently cite lack of cash for downpayment and closing costs as the primary barrier to becoming homeowners (Goodman et al. 2018). Black and Latino families have a fraction of the wealth of white families (see charts below). When cars (which are non-liquid assets and often overvalued by owners) are removed from the calculation, the median white family’s wealth increases from about 10 times the wealth of the median Black family and 8 times the wealth of the median Hispanic family to more than 30 times the wealth of the median Black family and over 20 times the wealth of the median Hispanic family (Moore and Bruenig 2017). 

Due to a legacy of being barred from wealth building opportunities, especially from the post WWII housing boom that created the white middle class, these gaps continue to compound from generation to generation.  Thirty percent of white families receive an inheritance or gift, compared to about 10 percent of Black families and 7 percent of Hispanic families. (Bhutta et al. 2020). These wealth disparities echo into all other areas of opportunity, across generations. For example, (A STAT FROM JUNG/KRISTEN’S FORTHCOMING STUDENT DEBT PAPER ON BORROWING FOR COLLEGE WHICH IN TURN MAKES IN HARDER TO BUY A HOME).

One report estimates that it would take the typical Latino renter household 11 years and the typical Black renter household 14 years to save for a 5% downpayment; and this does not even factor in closing costs and reserve requirements. Black households are less likely to have had parents who were homeowners and/or owned over $200,000 in wealth, both of which greatly increase the likelihood of becoming an owner (Choi,  Zhu & Goodman 2018). The median net worth of parents of young white adults is over $200,000, compared to less than $20,000 for parents of young Black adults and $35,000 for parents of young Latino adults. Gifts from relatives account for approximately 32% percent of down-payments for first-time home buyers (National Association of Realtors 2019), and loans from family and friends are also a substantial source of downpayment (Zillow 2022). More than 1.7 million mortgage-ready young Black renters could afford a median-price home in the 31 most-populous metropolitan statistical areas if they could come up with a funds to close (McCargo, Choi, and Golding 2019). 

In 2019, households of color accounted for 32 percent of all households but only held 24 percent of primary-residence housing wealth (Neal et al.2021, Dettling et al.2017). Even when they do become homeowners, they often do not reap the same wealth-building benefits as white households. There is evidence that homes owned by people of color as well as homes located in majority non-white communities are systematically undervalued by appraisers (by $48,000 per home on average) and these homes are susceptible to larger errors even in automated-valuations (Perry  2018, Neal, Strochak and Young 2020).



Median Household Wealth {.tabset}
-----------------------------------------------------------------------

### Median Wealth by Race, National
Black homebuyers are less likely to have access to wealth for down payments. The median wealth for Black households is $24,000 compared to $188,000 for white households. 

```{r echo = FALSE}

 wealth_gap %>% 
    ggplot(aes(x = race, y = wealth, label = scales::dollar(wealth))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_y_continuous(labels = scales::dollar_format()) +
    ggtitle("Median Wealth by Race, National") +
    xlab("Race") +
    ylab("Median Wealth") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```

### Median Household Wealth by Race, City
City-level results mirror the national results: in almost all cases the median wealth of white households is greater than the median wealth of black households. In Atlanta, the median wealth of Black households is $5,180, compared to $238,354 for white households.


```{r echo = FALSE}

  financial_health %>% 
    filter(city_name == "Atlanta, GA") %>%
    ggplot(aes(x = race, y = net_worth, label = scales::dollar(net_worth))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_y_continuous(labels = scales::dollar_format()) +
    ggtitle("Median Household Wealth by Race, Atlanta") +
    xlab("Race") +
    ylab("Median Wealth") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```

Cost Burden {.tabset}
-----------------------------------------------------------------------

### Rental Cost Burden by Race, National
Rental cost burden is just one component driving the wealth gap. Black families are much more likely to spend at least 30% of their income on rent, meaning they have a smaller proportion of their income available to save. Nationally, 51% of Black renter households are cost burdened, compared to only 42% of White households.

```{r echo = FALSE}

 national_burden %>%   
    ggplot(aes(x = race, y = burden_race_national, label = scales::percent(burden_race_national))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_fill_discrete(name = "Race", labels = c("Black", "White", "Total")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Rental Cost Burden by Race, National") +
    xlab("Race") +
    ylab("Rental Cost Burden Share") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```


### Rental Cost Burden by Race, MSA
In the Atlanta - Sandy Springs - Alpharetta MSA, 43% of Black Households are rental cost burdened, compared to 30% of white households. 

```{r echo = FALSE}

 burden %>%   
    filter(msa_name == "Atlanta-Sandy Springs-Alpharetta, GA Metro Area",
           geo_type == "msa") %>% 
    mutate(burden_share = round(burden_share, 2)) %>% 
    ggplot(aes(x = race, y = burden_share, label = scales::percent(burden_share))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +
    scale_x_discrete(labels = c("Black", "White", "Total")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Rental Cost Burden by Race, Atlanta MSA") +
    xlab("Race") +
    ylab("Cost Burden Share") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```

Wealth and Homeownership {.tabset}
-----------------------------------------------------------------------

### Wealth by Tenure, National
Homeownership is also a wealth-building vehicle, and the historic homeownership gap has limited wealth building opportunities for Black households. The median net worth for a homeowning household is $255,000, compared to only $6,300 for renters. Importantly, the majority of Black and Latino households are renting households.

```{r echo = FALSE}

  wealth_tenure %>% 
    ggplot(aes(x = tenure, y = wealth, label = scales::dollar(wealth))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_y_continuous(labels = scales::dollar_format()) +
    ggtitle("Median Wealth by Tenure") +
    xlab("Tenure") +
    ylab("Median Wealth") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```

### Homeownership Rate by Parental Wealth, National
Intergenerational wealth transfers also impact the ability to achieve homeownership. Homeownership rates increase as parental wealth increases.

```{r echo = FALSE}
 parent_wealth %>% 
    ggplot(aes(x = parent_worth, y = rate, label = scales::percent(rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_x_discrete(labels = c("Less than\n$10k", "$10k -\n$50k", "$50k -\n$150k", "$150k -\n$300", "$300k\n and above")) +
    ggtitle("Homeownership Rate by Parental Wealth, National") +
    xlab("Parental Wealth") +
    ylab("Homeownership Rate") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```

Race and Downpayments {.tabset}
-----------------------------------------------------------------------
### Percent of households putting down 5% or below and 20% or above by race, National
The wealth gap manifests in fewer resources for Black households for downpayments, limiting their homebuying options. Nationally, only 11% of Black households put down at least 20% on their home, compared to 39% for white households.

```{r echo = FALSE}

  ltv_national %>% 
    ggplot(aes(x = down, y = rate, fill = raceeth, label = scales::percent(rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7),
              vjust = -0.5)  +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +
    scale_x_discrete(labels = c("At least 20%", "5% and below")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Percent of Households Putting Down 5% or Below and 20% or Above by Race, National") +
    xlab("Down Payment Amount") +
    ylab("Share of Homebuyers") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```


### Percent of households putting down 5% or below and 20% or above by race, MSA
In the Atlanta - Sandy Springs - Alpharetta MSA, only 11% of Black households put down at least 20% on their home, comapred to 42% of white households.

```{r echo = FALSE}

  ltv %>% 
    filter(msa_name == "Atlanta-Sandy Springs-Alpharetta, GA Metro Area") %>% 
    ggplot(aes(x = payment, y = rate, fill = race, label = scales::percent(rate))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7),
              vjust = -0.5)  +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +
    scale_x_discrete(labels = c("At least 20%", "5% and below")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Percent of Households Putting Down 5% or Below and 20% or Above by Race, Atlanta MSA") +
    xlab("Down Payment Amount") +
    ylab("Share of Homebuyers") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))

```


### Used Gov't or Nonprofit Downpayment Assistance, National
13% of Black households used government or nonprofit downpayment assistance, compared to only 6% of white households, further indicating that Black downpayment savings remain a barrier for Black households. 

```{r echo = FALSE}

  source %>% 
    mutate(govt_np_asst = round(govt_np_asst, 3)) %>% 
    ggplot(aes(x = race_eth, y = govt_np_asst, label = scales::percent(govt_np_asst))) +
    geom_col(position = "dodge") +
    geom_text(position = position_dodge(width = .7), vjust = -0.5) +
    scale_fill_discrete(name = "", labels = c("Black", "White", "Total")) +
    scale_y_continuous(labels = scales::percent_format()) +
    ggtitle("Share of Homebuyers who Used Government or Nonprofit Downpayment Assistance, National") +
    xlab("Race") +
    ylab("Share of Homebuyers") +
    labs(caption = "Source: chart produced by Urban Institute, 2022.") +
    theme(axis.text.x = element_text(size= 20),
          axis.text.y = element_text(size = 20),
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          plot.caption = element_text(hjust = 0))


```

Market Analysis {.tabset}
-----------------------------------------------------------------------
This is a placeholder for a section that will include information to  help lenders target their programs. We will work with lenders to determine what would be most useful to include in this section. It will likely include an interactive map with census tract data on demographics, income, and homeownership rates by race. 

```{r echo = FALSE}

labels <- paste(
  "<strong><br>Homeownership Rates",
  "</strong><br>Black:", map_data$black,
  "</strong><br>White:", map_data$white,
  "</strong><br>Total:", map_data$total) %>% 
  lapply(htmltools::HTML)


  map_data %>% 
    leaflet() %>% 
    addProviderTiles(providers$Stamen.TonerLite) %>% 
    addPolygons(color = ~pal(county_name),
                weight = 0.5,
                label = ~labels,
                layerId = ~tract_name)

```

